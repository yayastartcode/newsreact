---
import { fetchApi } from '../lib/api';

interface Props {
  title?: string;
  categorySlug?: string;
}

const { title: propTitle, categorySlug: propCategorySlug } = Astro.props;

// Fetch settings to get trending_category
let settings: any = {};
try {
  settings = await fetchApi('/settings');
} catch (e) {
  console.error('Failed to fetch settings');
}

const categorySlug = propCategorySlug || settings.trending_category || null;
const title = propTitle || (categorySlug ? `Kategori: ${categorySlug}` : 'Trending Post');

// Fetch trending articles (6 posts) or by category
let articles: any[] = [];
try {
  if (categorySlug) {
    const data = await fetchApi(`/categories/${categorySlug}/articles?limit=6`);
    articles = data.articles || [];
  } else {
    articles = await fetchApi('/articles/trending?limit=6');
  }
} catch (e) {
  console.error('Failed to fetch trending articles');
}

function getImageUrl(path: string | null) {
  if (!path) return 'https://placehold.co/400x250/1e40af/ffffff?text=No+Image';
  if (path.startsWith('http')) return path;
  return path;
}

function formatDate(dateStr: string) {
  const date = new Date(dateStr);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const days = Math.floor(hours / 24);
  
  if (hours < 1) return 'Baru saja';
  if (hours < 24) return `${hours} jam lalu`;
  if (days < 7) return `${days} hari lalu`;
  if (days < 30) return `${Math.floor(days / 7)} minggu lalu`;
  return `${Math.floor(days / 30)} bulan lalu`;
}

function getArticleUrl(article: any) {
  const date = new Date(article.published_at);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `/${year}/${month}/${day}/${article.slug}`;
}

function padNumber(num: number) {
  return num.toString().padStart(2, '0');
}
---

{articles.length > 0 && (
  <section class="trending-section">
    <h2 class="section-title">{title}</h2>
    <div class="trending-grid">
      {articles.map((article, index) => (
        <a href={getArticleUrl(article)} class="trending-card">
          <img src={getImageUrl(article.featured_image)} alt={article.title} class="card-bg" />
          <div class="card-overlay">
            <div class="card-header">
              <span class="card-number">{padNumber(index + 1)}</span>
              <span class="card-line"></span>
              <span class="card-date">{formatDate(article.published_at)}</span>
            </div>
            <h3 class="card-title">{article.title}</h3>
          </div>
        </a>
      ))}
    </div>
  </section>
)}

<style>
  .trending-section {
    margin-bottom: 2rem;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }

  .trending-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .trending-card {
    position: relative;
    border-radius: 0.5rem;
    overflow: hidden;
    aspect-ratio: 16 / 10;
  }

  .card-bg {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
  }

  .trending-card:hover .card-bg {
    transform: scale(1.05);
  }

  .card-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.8));
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 1rem;
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .card-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #ef4444;
  }

  .card-line {
    flex: 1;
    height: 1px;
    background: rgba(255,255,255,0.5);
  }

  .card-date {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.8);
  }

  .card-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: white;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media (max-width: 900px) {
    .trending-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .trending-grid {
      grid-template-columns: 1fr;
    }
    
    .card-number {
      font-size: 1.25rem;
    }
  }
</style>
