---
import { fetchApi } from '../lib/api';

// Fetch featured articles (5)
let featuredArticles: any[] = [];
try {
  featuredArticles = await fetchApi('/articles/featured?limit=5');
} catch (e) {
  console.error('Failed to fetch featured articles');
}

// Fetch recent articles (5)
let recentArticles: any[] = [];
try {
  const data = await fetchApi('/articles?limit=5');
  recentArticles = data.articles || [];
} catch (e) {
  console.error('Failed to fetch recent articles');
}

// Fetch trending articles (5)
let trendingArticles: any[] = [];
try {
  trendingArticles = await fetchApi('/articles/trending?limit=5');
} catch (e) {
  console.error('Failed to fetch trending articles');
}

function getImageUrl(path: string | null) {
  if (!path) return 'https://placehold.co/800x450/1e40af/ffffff?text=No+Image';
  if (path.startsWith('http')) return path;
  return path;
}

function formatDate(dateStr: string) {
  const date = new Date(dateStr);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const days = Math.floor(hours / 24);
  
  if (hours < 1) return 'Baru saja';
  if (hours < 24) return `${hours} jam lalu`;
  if (days < 7) return `${days} hari lalu`;
  return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
}

function getArticleUrl(article: any) {
  const date = new Date(article.published_at);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `/${year}/${month}/${day}/${article.slug}`;
}
---

<div class="hero-wrapper">
  <!-- Left Column: Sliders -->
  <div class="hero-left">
    <!-- Big Featured Slider -->
    <div class="featured-slider">
      <span class="featured-badge">UNGGULAN</span>
      <div class="slider-container" id="featured-slider">
        {featuredArticles.length > 0 ? (
          featuredArticles.map((article, index) => (
            <a href={getArticleUrl(article)} class={`slide ${index === 0 ? 'active' : ''}`}>
              <img src={getImageUrl(article.featured_image)} alt={article.title} class="slide-image" />
              <div class="slide-overlay">
                <span class="slide-date">{formatDate(article.published_at)}</span>
                <h2 class="slide-title">{article.title}</h2>
              </div>
            </a>
          ))
        ) : (
          <div class="slide active">
            <img src="/images/placeholder.jpg" alt="No featured" class="slide-image" />
            <div class="slide-overlay">
              <span class="slide-date">-</span>
              <h2 class="slide-title">Belum ada artikel unggulan</h2>
            </div>
          </div>
        )}
      </div>
      {featuredArticles.length > 1 && (
        <div class="slider-dots">
          {featuredArticles.map((_, index) => (
            <button class={`dot ${index === 0 ? 'active' : ''}`} data-index={index}></button>
          ))}
        </div>
      )}
    </div>

    <!-- Small Recent Slider -->
    <div class="recent-slider">
      <span class="recent-badge">Terbaru</span>
      <div class="recent-track" id="recent-slider">
        {recentArticles.length > 0 ? (
          [...recentArticles, ...recentArticles].map((article) => (
            <a href={getArticleUrl(article)} class="recent-card">
              <img src={getImageUrl(article.featured_image)} alt={article.title} class="recent-image" loading="lazy" />
              <div class="recent-content">
                <span class="recent-date">{formatDate(article.published_at)}</span>
                <h3 class="recent-title">{article.title}</h3>
              </div>
            </a>
          ))
        ) : (
          <div class="recent-card">
            <img src="https://placehold.co/800x450/1e40af/ffffff?text=No+Image" alt="No recent" class="recent-image" loading="lazy" />
            <div class="recent-content">
              <span class="recent-date">-</span>
              <h3 class="recent-title">Belum ada artikel</h3>
            </div>
          </div>
        )}
      </div>
    </div>
  </div>

  <!-- Right Column: Trending -->
  <aside class="hero-right">
    <h3 class="trending-title">Trending</h3>
    <div class="trending-list">
      {trendingArticles.length > 0 ? (
        trendingArticles.map((article) => (
          <a href={getArticleUrl(article)} class="trending-item">
            <div class="trending-info">
              <span class="trending-date">{formatDate(article.published_at)}</span>
              <h4 class="trending-name">{article.title}</h4>
              <span class="trending-views">üëÅ {article.view_count || 0}</span>
            </div>
            <img src={getImageUrl(article.featured_image)} alt={article.title} class="trending-thumb" loading="lazy" />
          </a>
        ))
      ) : (
        <div class="trending-item">
          <div class="trending-info">
            <span class="trending-date">-</span>
            <h4 class="trending-name">Belum ada data</h4>
          </div>
          <img src="/images/placeholder.jpg" alt="No data" class="trending-thumb" />
        </div>
      )}
    </div>
  </aside>
</div>

<style>
  /* Simple Flexbox Layout */
  .hero-wrapper {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .hero-left {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .hero-right {
    width: 280px;
    flex-shrink: 0;
  }

  /* Featured Slider */
  .featured-slider {
    position: relative;
    border-radius: 0.5rem;
    overflow: hidden;
    aspect-ratio: 16 / 9;
    background: #e2e8f0;
  }

  .featured-badge {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    background: #1e40af;
    color: white;
    padding: 0.25rem 0.5rem;
    font-size: 0.65rem;
    font-weight: 700;
    border-radius: 0.25rem;
    z-index: 10;
  }

  .slider-container {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .slide {
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.4s;
  }

  .slide.active { opacity: 1; }

  .slide-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .slide-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1.5rem;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    color: white;
  }

  .slide-date {
    font-size: 0.75rem;
    opacity: 0.8;
  }

  .slide-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin-top: 0.25rem;
    line-height: 1.3;
  }

  .slider-dots {
    position: absolute;
    bottom: 0.75rem;
    right: 0.75rem;
    display: flex;
    gap: 0.375rem;
    z-index: 10;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255,255,255,0.5);
    border: none;
    cursor: pointer;
  }

  .dot.active { background: white; }

  /* Recent Slider */
  .recent-slider {
    position: relative;
    overflow: hidden;
  }

  .recent-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    background: #0f172a;
    color: white;
    padding: 0.2rem 0.4rem;
    font-size: 0.6rem;
    font-weight: 600;
    border-radius: 0.25rem;
    z-index: 10;
  }

  .recent-track {
    display: flex;
    gap: 0.75rem;
    animation: scroll 20s linear infinite;
  }

  .recent-track:hover { animation-play-state: paused; }

  .recent-card {
    flex-shrink: 0;
    width: 180px;
    border-radius: 0.375rem;
    overflow: hidden;
    border: 1px solid #e2e8f0;
    background: white;
  }

  .recent-image {
    width: 100%;
    aspect-ratio: 16 / 10;
    object-fit: cover;
  }

  .recent-content {
    padding: 0.5rem;
  }

  .recent-date {
    font-size: 0.65rem;
    color: #64748b;
  }

  .recent-title {
    font-size: 0.8rem;
    font-weight: 600;
    margin-top: 0.125rem;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @keyframes scroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }

  /* Trending Sidebar */
  .hero-right {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    padding: 0.75rem;
  }

  .trending-title {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #1e40af;
  }

  .trending-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .trending-item {
    display: flex;
    gap: 0.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .trending-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .trending-info {
    flex: 1;
    min-width: 0;
  }

  .trending-date {
    font-size: 0.65rem;
    color: #64748b;
  }

  .trending-name {
    font-size: 0.8rem;
    font-weight: 600;
    margin: 0.125rem 0;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .trending-views {
    font-size: 0.65rem;
    color: #64748b;
  }

  .trending-thumb {
    width: 70px;
    height: 50px;
    object-fit: cover;
    border-radius: 0.25rem;
    flex-shrink: 0;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .hero-wrapper {
      flex-direction: column;
    }

    .hero-right {
      width: 100%;
      order: -1;
    }

    .trending-list {
      flex-direction: row;
      overflow-x: auto;
      gap: 0.5rem;
      padding-bottom: 0.5rem;
    }

    .trending-item {
      flex-shrink: 0;
      width: 200px;
      flex-direction: column-reverse;
      border: 1px solid #e2e8f0;
      border-radius: 0.375rem;
      padding: 0;
      overflow: hidden;
    }

    .trending-info {
      padding: 0.5rem;
    }

    .trending-thumb {
      width: 100%;
      height: 100px;
    }

    .slide-title {
      font-size: 1rem;
    }

    .recent-card {
      width: 150px;
    }
  }
</style>

<script>
  const slides = document.querySelectorAll('#featured-slider .slide');
  const dots = document.querySelectorAll('.slider-dots .dot');
  let current = 0;
  let timer: ReturnType<typeof setInterval>;

  function show(i: number) {
    slides.forEach((s, idx) => s.classList.toggle('active', idx === i));
    dots.forEach((d, idx) => d.classList.toggle('active', idx === i));
    current = i;
  }

  function next() { show((current + 1) % slides.length); }

  function start() { timer = setInterval(next, 5000); }
  function stop() { clearInterval(timer); }

  dots.forEach((dot, i) => {
    dot.addEventListener('click', () => { show(i); stop(); start(); });
  });

  const slider = document.querySelector('.featured-slider');
  slider?.addEventListener('mouseenter', stop);
  slider?.addEventListener('mouseleave', start);

  if (slides.length > 1) start();
</script>
