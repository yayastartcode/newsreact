---
import { fetchApi } from '../lib/api';

// Fetch 5 newest articles
let articles: any[] = [];
try {
  const data = await fetchApi('/articles?limit=5');
  articles = data.articles || [];
} catch (e) {
  console.error('Failed to fetch recent articles for bar');
}

const API_SERVER = 'http://127.0.0.1:5001';

function getImageUrl(path: string | null) {
  if (!path) return 'https://placehold.co/80x80/1e40af/ffffff?text=?';
  if (path.startsWith('http')) return path;
  return API_SERVER + path;
}

function formatDate(dateStr: string) {
  const date = new Date(dateStr);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const days = Math.floor(hours / 24);
  
  if (hours < 1) return 'Baru saja';
  if (hours < 24) return `${hours} jam lalu`;
  if (days < 7) return `${days} hari lalu`;
  if (days < 30) return `${Math.floor(days / 7)} minggu lalu`;
  return `${Math.floor(days / 30)} bulan lalu`;
}

function getArticleUrl(article: any) {
  const date = new Date(article.published_at);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `/${year}/${month}/${day}/${article.slug}`;
}
---

{articles.length > 0 && (
  <div class="posts-bar">
    <div class="posts-track">
      {[...articles, ...articles].map((article) => (
        <a href={getArticleUrl(article)} class="post-item">
          <img src={getImageUrl(article.featured_image)} alt={article.title} class="post-thumb" />
          <div class="post-info">
            <div class="post-meta">
              <span class="post-date">‚óè {formatDate(article.published_at)}</span>
              <span class="post-views">üëÅ {article.view_count || 0}</span>
            </div>
            <h3 class="post-title">{article.title}</h3>
          </div>
        </a>
      ))}
    </div>
  </div>
)}

<style>
  .posts-bar {
    background: white;
    border-top: 3px solid #ef4444;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    padding: 0.75rem 1rem;
    overflow: hidden;
    margin-bottom: 2rem;
  }

  .posts-track {
    display: flex;
    gap: 2rem;
    animation: slide 25s linear infinite;
  }

  .posts-track:hover {
    animation-play-state: paused;
  }

  .post-item {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 260px;
  }

  .post-thumb {
    width: 85px;
    height: 85px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }

  .post-info {
    flex: 1;
    min-width: 0;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.2rem;
  }

  .post-date {
    font-size: 0.7rem;
    color: #ef4444;
  }

  .post-views {
    font-size: 0.7rem;
    color: #9ca3af;
  }

  .post-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #1e293b;
    line-height: 1.35;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @keyframes slide {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }

  @media (max-width: 768px) {
    .post-item {
      min-width: 220px;
    }
    
    .post-thumb {
      width: 55px;
      height: 55px;
    }
    
    .post-title {
      font-size: 0.8rem;
    }
  }
</style>
